<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>턴제 격투 PVP</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: black;
      color: lime;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    #log {
      width: 100%;
      max-width: 600px;
      height: 300px;
      overflow-y: scroll;
      border: 1px solid lime;
      background: #111;
      padding: 10px;
    }
    .btns {
      margin-top: 10px;
    }
    button {
      background: lime;
      color: black;
      padding: 10px;
      margin: 5px;
      cursor: pointer;
    }
    #turn {
      margin-top: 10px;
      font-size: 1.2em;
    }
    #timer {
      font-size: 1.2em;
      margin: 5px;
    }
    #battlefield {
      margin-top: 20px;
      display: flex;
      justify-content: space-around;
      width: 600px;
    }
    #battlefield img {
      width: 200px;
      height: auto;
    }
    #healthbar {
      display: flex;
      justify-content: space-around;
      width: 600px;
      margin-bottom: 10px;
    }
    progress {
      width: 200px;
      height: 20px;
    }
    #resultBanner {
      margin-top: 10px;
      display: none;
    }
    #resultBanner img {
      width: 180px;
    }
  </style>
</head>
<body>
  <h1>턴제 격투 PVP</h1>

  <div id="healthbar">
    <div>
      <span>YOU</span>
      <progress id="playerHP" value="3" max="3"></progress>
    </div>
    <div>
      <span>ENEMY</span>
      <progress id="enemyHP" value="3" max="3"></progress>
    </div>
  </div>

  <div id="turn">상대 기다리는 중...</div>
  <div id="timer">제한 시간: -</div>

  <div id="battlefield">
    <img id="playerSprite" src="tv_girl/stand.png" alt="player">
    <img id="enemySprite" src="tv_girl/stand.png" alt="enemy">
  </div>

  <div id="resultBanner">
    <img id="resultImage" src="" alt="result" />
  </div>

  <div class="btns" id="attackBtns" style="display: none;">
    <button onclick="choose('high')">상단 공격</button>
    <button onclick="choose('low')">하단 공격</button>
    <button onclick="choose('grab')">잡기</button>
  </div>
  <div class="btns" id="defendBtns" style="display: none;">
    <button onclick="choose('high')">상단 방어</button>
    <button onclick="choose('low')">하단 방어</button>
    <button onclick="choose('grab')">잡기 방어</button>
  </div>

  <div id="log"></div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const socket = io("https://moondo-production.up.railway.app");
    const logDiv = document.getElementById("log");
    const turnDiv = document.getElementById("turn");
    const timerDiv = document.getElementById("timer");
    const attackBtns = document.getElementById("attackBtns");
    const defendBtns = document.getElementById("defendBtns");
    const playerSprite = document.getElementById("playerSprite");
    const enemySprite = document.getElementById("enemySprite");
    const playerHP = document.getElementById("playerHP");
    const enemyHP = document.getElementById("enemyHP");
    const resultBanner = document.getElementById("resultBanner");
    const resultImage = document.getElementById("resultImage");

    let isMyTurn = false;
    let timeout;
    let countdown;
    let currentRole = null;

    function log(msg) {
      logDiv.innerHTML += `> ${msg}<br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function startTimer() {
      let timeLeft = 10;
      timerDiv.textContent = `제한 시간: ${timeLeft}`;
      countdown = setInterval(() => {
        timeLeft--;
        timerDiv.textContent = `제한 시간: ${timeLeft}`;
        if (timeLeft <= 0) clearInterval(countdown);
      }, 1000);

      timeout = setTimeout(() => {
        choose(null); // 시간 초과 처리
      }, 10000);
    }

    function choose(action) {
      clearInterval(countdown);
      clearTimeout(timeout);
      timerDiv.textContent = `제한 시간: -`;

      attackBtns.style.display = "none";
      defendBtns.style.display = "none";

      if (currentRole === 'attack') {
        if (action === 'high') playerSprite.src = "tv_girl/kick.png";
        else if (action === 'low') playerSprite.src = "tv_girl/punch.png";
        else if (action === 'grab') playerSprite.src = "tv_girl/grab.png";
      } else if (currentRole === 'defend') {
        playerSprite.src = "tv_girl/stand.png";
      }

      socket.emit("player_action", { action });
    }

    socket.on("your_turn", ({ role }) => {
      isMyTurn = true;
      currentRole = role;
      turnDiv.textContent = role === 'attack' ? "[당신의 공격 턴]" : "[당신의 방어 턴]";
      playerSprite.src = "tv_girl/stand.png";
      enemySprite.src = "tv_girl/stand.png";
      resultBanner.style.display = "none"; // 게임 시작 시 결과 이미지 숨김

      if (role === 'attack') attackBtns.style.display = "block";
      else defendBtns.style.display = "block";

      startTimer();
    });

    socket.on("turn_result", ({ msg, result }) => {
      isMyTurn = false;
      log(msg);
      turnDiv.textContent = "상대의 턴...";

      if (result === 'hit') {
        enemySprite.src = "tv_girl/hit.png";
      } else if (result === 'guard') {
        enemySprite.src = "tv_girl/guard.png";
      } else if (result === 'win') {
        resultBanner.style.display = "block";
        resultImage.src = "tv_girl/victory.png";
      } else if (result === 'lose') {
        resultBanner.style.display = "block";
        resultImage.src = "tv_girl/defeat.png";
      }

      setTimeout(() => {
        if (result !== 'win' && result !== 'lose') {
          playerSprite.src = "tv_girl/stand.png";
          enemySprite.src = "tv_girl/stand.png";
        }
      }, 1000);
    });

    socket.on("hp_update", ({ my, enemy }) => {
      playerHP.value = my;
      enemyHP.value = enemy;
    });

    socket.on("game_start", ({ first }) => {
      log(`동전 던지기 결과: ${first ? "당신이 선공입니다!" : "상대가 선공입니다."}`);
      resultBanner.style.display = "none";
    });

    socket.on("waiting", () => {
      turnDiv.textContent = "상대 기다리는 중...";
    });

    socket.on("opponent_disconnected", () => {
      log("상대가 나갔습니다. 새로고침으로 다시 시작하세요.");
    });
  </script>
</body>
</html>
