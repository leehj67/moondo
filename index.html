<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>턴제 격투 PVP</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: black;
      color: lime;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    #log {
      width: 100%;
      max-width: 600px;
      height: 300px;
      overflow-y: scroll;
      border: 1px solid lime;
      background: #111;
      padding: 10px;
    }
    .btns {
      margin-top: 10px;
    }
    button {
      background: lime;
      color: black;
      padding: 10px;
      margin: 5px;
      cursor: pointer;
    }
    #turn {
      margin-top: 10px;
      font-size: 1.2em;
    }
    #timer {
      font-size: 1.2em;
      margin: 5px;
    }
    #character {
      margin-top: 20px;
    }
    #character img {
      width: 200px;
      height: auto;
    }
  </style>
</head>
<body>
  <h1>턴제 격투 PVP</h1>

  <div id="turn">상대 기다리는 중...</div>
  <div id="timer">제한 시간: -</div>

  <div id="character">
    <img id="playerSprite" src="tv_girl/stand.png" alt="player">
  </div>

  <div class="btns" id="attackBtns" style="display: none;">
    <button onclick="choose('high')">상단 공격</button>
    <button onclick="choose('low')">하단 공격</button>
    <button onclick="choose('grab')">잡기</button>
  </div>
  <div class="btns" id="defendBtns" style="display: none;">
    <button onclick="choose('high')">상단 방어</button>
    <button onclick="choose('low')">하단 방어</button>
    <button onclick="choose('grab')">잡기 방어</button>
  </div>

  <div id="log"></div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    const socket = io("https://moondo-production.up.railway.app");
    const logDiv = document.getElementById("log");
    const turnDiv = document.getElementById("turn");
    const timerDiv = document.getElementById("timer");
    const attackBtns = document.getElementById("attackBtns");
    const defendBtns = document.getElementById("defendBtns");
    const sprite = document.getElementById("playerSprite");

    let isMyTurn = false;
    let timeout;
    let countdown;
    let currentRole = null;

    function log(msg) {
      logDiv.innerHTML += `> ${msg}<br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function startTimer() {
      let timeLeft = 10;
      timerDiv.textContent = `제한 시간: ${timeLeft}`;
      countdown = setInterval(() => {
        timeLeft--;
        timerDiv.textContent = `제한 시간: ${timeLeft}`;
        if (timeLeft <= 0) clearInterval(countdown);
      }, 1000);

      timeout = setTimeout(() => {
        choose(null); // 시간 초과 처리
      }, 10000);
    }

    function choose(action) {
      clearInterval(countdown);
      clearTimeout(timeout);
      timerDiv.textContent = `제한 시간: -`;

      attackBtns.style.display = "none";
      defendBtns.style.display = "none";

      if (currentRole === 'attack') {
        if (action === 'high') sprite.src = "tv_girl/high_kick.png";
        else if (action === 'low') sprite.src = "tv_girl/punch.png";
        else if (action === 'grab') sprite.src = "tv_girl/grap.png";
      } else if (currentRole === 'defend') {
        sprite.src = "tv_girl/stand.png";
      }

      socket.emit("player_action", { action });
    }

    socket.on("your_turn", ({ role }) => {
      isMyTurn = true;
      currentRole = role;
      turnDiv.textContent = role === 'attack' ? "[당신의 공격 턴]" : "[당신의 방어 턴]";
      sprite.src = "tv_girl/stand.png";
      if (role === 'attack') attackBtns.style.display = "block";
      else defendBtns.style.display = "block";
      startTimer();
    });

    socket.on("turn_result", ({ msg }) => {
      isMyTurn = false;
      log(msg);
      turnDiv.textContent = "상대의 턴...";
    });

    socket.on("game_start", ({ first }) => {
      log(`동전 던지기 결과: ${first ? "당신이 선공입니다!" : "상대가 선공입니다."}`);
    });

    socket.on("waiting", () => {
      turnDiv.textContent = "상대 기다리는 중...";
    });

    socket.on("opponent_disconnected", () => {
      log("상대가 나갔습니다. 새로고침으로 다시 시작하세요.");
    });
  </script>
</body>
</html>
